<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestorFederal</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app"></div>
    <script>
        let state = {
            user: null,
            users: [{id:1,username:'admin',password:'admin123',role:'admin',name:'Admin'}],
            timers: {},
            codes: {},
            records: [],
            actas: [],
            coms: [],
            view: 'login'
        };

        function save() {
            try {
                localStorage.setItem('gf', JSON.stringify({
                    users: state.users,
                    codes: state.codes,
                    records: state.records,
                    actas: state.actas,
                    coms: state.coms
                }));
            } catch(e) {}
        }

        function load() {
            try {
                const d = localStorage.getItem('gf');
                if (d) {
                    const parsed = JSON.parse(d);
                    state.users = parsed.users || state.users;
                    state.codes = parsed.codes || {};
                    state.records = parsed.records || [];
                    state.actas = parsed.actas || [];
                    state.coms = parsed.coms || [];
                }
            } catch(e) {}
        }

        function fmt(s) {
            const h = Math.floor(s/3600);
            const m = Math.floor((s%3600)/60);
            const sec = s%60;
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        function login(e) {
            e.preventDefault();
            const u = document.getElementById('u').value;
            const p = document.getElementById('p').value;
            const user = state.users.find(x => x.username === u && x.password === p);
            if (user) {
                state.user = user;
                state.view = user.role === 'admin' ? 'admin' : user.role === 'alto' ? 'alto' : 'bajo';
                render();
            } else {
                alert('Credenciales incorrectas');
            }
        }

        function logout() {
            state.user = null;
            state.view = 'login';
            render();
        }

        function genCode() {
            const code = Math.random().toString(36).substring(2,8).toUpperCase();
            state.codes[code] = {
                altoId: state.user.id,
                altoName: state.user.name,
                used: []
            };
            save();
            alert('C√≥digo: ' + code);
            render();
        }

        function startTimer() {
            const code = document.getElementById('code').value.toUpperCase();
            if (!state.codes[code]) {
                alert('C√≥digo inv√°lido');
                return;
            }
            state.timers[state.user.id] = {
                elapsed: 0,
                running: true,
                altoId: state.codes[code].altoId,
                altoName: state.codes[code].altoName,
                code: code
            };
            state.codes[code].used.push(state.user.id);
            save();
            render();
        }

        function toggle() {
            if (state.timers[state.user.id]) {
                state.timers[state.user.id].running = !state.timers[state.user.id].running;
                render();
            }
        }

        function stop() {
            const t = state.timers[state.user.id];
            if (t) {
                const mins = Math.floor(t.elapsed/60);
                const h = Math.floor(mins/60);
                const m = mins%60;
                state.records.push({
                    id: state.records.length+1,
                    userId: state.user.id,
                    userName: state.user.name,
                    altoId: t.altoId,
                    altoName: t.altoName,
                    secs: t.elapsed,
                    h: h,
                    m: m,
                    date: new Date().toISOString()
                });
                delete state.timers[state.user.id];
                save();
                alert(`Registrado: ${h}h ${m}m`);
                render();
            }
        }

        function stopUser(uid) {
            const t = state.timers[uid];
            if (t) {
                const mins = Math.floor(t.elapsed/60);
                const h = Math.floor(mins/60);
                const m = mins%60;
                const u = state.users.find(x => x.id === uid);
                state.records.push({
                    id: state.records.length+1,
                    userId: uid,
                    userName: u.name,
                    altoId: t.altoId,
                    altoName: t.altoName,
                    secs: t.elapsed,
                    h: h,
                    m: m,
                    date: new Date().toISOString()
                });
                delete state.timers[uid];
                save();
                alert(`Detenido: ${u.name} - ${h}h ${m}m`);
                render();
            }
        }

        function addUser(e) {
            e.preventDefault();
            const name = document.getElementById('un').value;
            const user = document.getElementById('uu').value;
            const pass = document.getElementById('up').value;
            const role = document.getElementById('ur').value;
            if (state.users.find(x => x.username === user)) {
                alert('Usuario existe');
                return;
            }
            state.users.push({id: state.users.length+1, username: user, password: pass, role: role, name: name});
            save();
            alert('Usuario creado');
            render();
        }

        function addActa(e) {
            e.preventDefault();
            const uid = parseInt(document.getElementById('au').value);
            const mot = document.getElementById('am').value;
            const u = state.users.find(x => x.id === uid);
            state.actas.push({
                id: state.actas.length+1,
                uid: uid,
                uname: u.name,
                mot: mot,
                by: state.user.name,
                date: new Date().toISOString()
            });
            save();
            alert('Acta creada');
            render();
        }

        function addCom(e) {
            e.preventDefault();
            if (state.coms.length >= 10) {
                alert('M√°ximo 10 comunicados');
                return;
            }
            const tit = document.getElementById('ct').value;
            const con = document.getElementById('cc').value;
            const urg = document.getElementById('cu').checked;
            state.coms.push({
                id: state.coms.length+1,
                tit: tit,
                con: con,
                urg: urg,
                by: state.user.name,
                date: new Date().toISOString()
            });
            save();
            alert('Comunicado creado');
            render();
        }

        function delCom(id) {
            state.coms = state.coms.filter(x => x.id !== id);
            save();
            render();
        }

        function calcStats() {
            const st = {};
            state.records.forEach(r => {
                if (!r.altoId) return;
                if (!st[r.altoId]) {
                    st[r.altoId] = {name: r.altoName, tot: 0, pend: 0, comp: 0};
                }
                const mins = Math.floor(r.secs/60);
                st[r.altoId].tot += mins;
                const newT = st[r.altoId].pend + mins;
                const ch = Math.floor(newT/60);
                const rm = newT%60;
                st[r.altoId].comp += ch;
                st[r.altoId].pend = rm;
            });
            return Object.values(st);
        }

        function render() {
            const app = document.getElementById('app');
            if (state.view === 'login') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-900 to-blue-700 flex items-center justify-center p-4">
                        <div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
                            <h1 class="text-4xl font-bold text-blue-900 text-center mb-2">GestorFederal</h1>
                            <p class="text-gray-600 text-center mb-6">Control de Tiempos</p>
                            <form onsubmit="login(event)" class="space-y-4">
                                <input type="text" id="u" placeholder="Usuario" required class="w-full px-4 py-3 border rounded-lg">
                                <input type="password" id="p" placeholder="Contrase√±a" required class="w-full px-4 py-3 border rounded-lg">
                                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-medium">Ingresar</button>
                            </form>
                            <div class="mt-4 p-3 bg-gray-50 rounded text-sm">
                                <p class="font-medium">Prueba: admin / admin123</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.view === 'admin') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-100">
                        <nav class="bg-blue-900 text-white p-4">
                            <div class="container mx-auto flex justify-between">
                                <h1 class="text-xl font-bold">GestorFederal - Admin</h1>
                                <button onclick="logout()" class="bg-blue-700 px-4 py-2 rounded hover:bg-blue-600">Salir</button>
                            </div>
                        </nav>
                        <div class="container mx-auto p-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                <button onclick="state.view='users';render()" class="bg-white p-6 rounded-lg shadow hover:shadow-lg">
                                    <h3 class="font-bold">üë• Usuarios</h3>
                                </button>
                                <button onclick="state.view='actas';render()" class="bg-white p-6 rounded-lg shadow hover:shadow-lg">
                                    <h3 class="font-bold">üìÑ Actas</h3>
                                </button>
                                <button onclick="state.view='bit';render()" class="bg-white p-6 rounded-lg shadow hover:shadow-lg">
                                    <h3 class="font-bold">üèÜ Bit√°cora</h3>
                                </button>
                                <button onclick="state.view='coms';render()" class="bg-white p-6 rounded-lg shadow hover:shadow-lg">
                                    <h3 class="font-bold">üì¢ Comunicados</h3>
                                </button>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <h2 class="text-2xl font-bold mb-4">Estad√≠sticas</h2>
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="bg-blue-50 p-4 rounded">
                                        <p class="text-sm text-gray-600">Usuarios</p>
                                        <p class="text-3xl font-bold text-blue-600">${state.users.length}</p>
                                    </div>
                                    <div class="bg-green-50 p-4 rounded">
                                        <p class="text-sm text-gray-600">Registros</p>
                                        <p class="text-3xl font-bold text-green-600">${state.records.length}</p>
                                    </div>
                                    <div class="bg-purple-50 p-4 rounded">
                                        <p class="text-sm text-gray-600">Actas</p>
                                        <p class="text-3xl font-bold text-purple-600">${state.actas.length}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.view === 'users') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-100">
                        <nav class="bg-blue-900 text-white p-4">
                            <div class="container mx-auto flex justify-between">
                                <h1 class="text-xl font-bold">Usuarios</h1>
                                <button onclick="state.view='admin';render()" class="bg-blue-700 px-4 py-2 rounded">Volver</button>
                            </div>
                        </nav>
                        <div class="container mx-auto p-4">
                            <div class="bg-white rounded-lg shadow p-6 mb-6">
                                <h2 class="text-xl font-bold mb-4">Crear Usuario</h2>
                                <form onsubmit="addUser(event)" class="grid grid-cols-2 gap-4">
                                    <input type="text" id="un" placeholder="Nombre" required class="px-4 py-2 border rounded">
                                    <input type="text" id="uu" placeholder="Usuario" required class="px-4 py-2 border rounded">
                                    <input type="password" id="up" placeholder="Contrase√±a" required class="px-4 py-2 border rounded">
                                    <select id="ur" class="px-4 py-2 border rounded">
                                        <option value="bajo">Cargo Bajo</option>
                                        <option value="alto">Cargo Alto</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                    <button type="submit" class="col-span-2 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Crear</button>
                                </form>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <h2 class="text-xl font-bold mb-4">Lista</h2>
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left">Nombre</th>
                                            <th class="px-4 py-2 text-left">Usuario</th>
                                            <th class="px-4 py-2 text-left">Rol</th>
                                            <th class="px-4 py-2 text-left">Pass</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${state.users.map(u => `
                                        <tr class="border-t">
                                            <td class="px-4 py-2">${u.name}</td>
                                            <td class="px-4 py-2">${u.username}</td>
                                            <td class="px-4 py-2"><span class="px-2 py-1 text-xs rounded ${u.role==='admin'?'bg-red-100':'bg-blue-100'}">${u.role}</span></td>
                                            <td class="px-4 py-2">${u.password}</td>
                                        </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.view === 'actas') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-100">
                        <nav class="bg-blue-900 text-white p-4">
                            <div class="container mx-auto flex justify-between">
                                <h1 class="text-xl font-bold">Actas</h1>
                                <button onclick="state.view='admin';render()" class="bg-blue-700 px-4 py-2 rounded">Volver</button>
                            </div>
                        </nav>
                        <div class="container mx-auto p-4">
                            <div class="bg-white rounded-lg shadow p-6 mb-6">
                                <h2 class="text-xl font-bold mb-4">Crear Acta</h2>
                                <form onsubmit="addActa(event)" class="space-y-4">
                                    <select id="au" class="w-full px-4 py-2 border rounded" required>
                                        <option value="">Seleccionar trabajador</option>
                                        ${state.users.filter(u => u.role !== 'admin').map(u => `<option value="${u.id}">${u.name}</option>`).join('')}
                                    </select>
                                    <textarea id="am" placeholder="Motivo" class="w-full px-4 py-2 border rounded h-32" required></textarea>
                                    <button type="submit" class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700">Crear</button>
                                </form>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <h2 class="text-xl font-bold mb-4">Registradas</h2>
                                ${state.actas.length === 0 ? '<p class="text-gray-500 text-center py-4">Sin actas</p>' :
                                state.actas.map(a => `
                                <div class="border rounded p-4 mb-4 bg-red-50">
                                    <h3 class="font-bold">${a.uname}</h3>
                                    <p class="text-sm text-gray-600">Por: ${a.by} ‚Ä¢ ${new Date(a.date).toLocaleDateString()}</p>
                                    <p class="mt-2">${a.mot}</p>
                                </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.view === 'bit') {
                const stats = calcStats();
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-100">
                        <nav class="bg-blue-900 text-white p-4">
                            <div class="container mx-auto flex justify-between">
                                <h1 class="text-xl font-bold">Bit√°cora</h1>
                                <button onclick="state.view='admin';render()" class="bg-blue-700 px-4 py-2 rounded">Volver</button>
                            </div>
                        </nav>
                        <div class="container mx-auto p-4">
                            <div class="bg-white rounded-lg shadow p-6 mb-6">
                                <h2 class="text-xl font-bold mb-4">Horas Completas Cargos Altos</h2>
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left">Cargo Alto</th>
                                            <th class="px-4 py-2 text-left">Horas</th>
                                            <th class="px-4 py-2 text-left">Min. Pend.</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${stats.length === 0 ? '<tr><td colspan="3" class="px-4 py-8 text-center text-gray-500">Sin datos</td></tr>' :
                                        stats.map(s => `
                                        <tr class="border-t">
                                            <td class="px-4 py-3">${s.name}</td>
                                            <td class="px-4 py-3"><span class="bg-green-100 px-3 py-1 rounded font-bold">${s.comp}h</span></td>
                                            <td class="px-4 py-3">${s.pend} min</td>
                                        </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <h2 class="text-xl font-bold mb-4">Todos los Registros</h2>
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 py-2 text-left">Fecha</th>
                                            <th class="px-3 py-2 text-left">Trabajador</th>
                                            <th class="px-3 py-2 text-left">Cargo Alto</th>
                                            <th class="px-3 py-2 text-left">Tiempo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${state.records.length === 0 ? '<tr><td colspan="4" class="px-3 py-8 text-center text-gray-500">Sin registros</td></tr>' :
                                        state.records.map(r => `
                                        <tr class="border-t">
                                            <td class="px-3 py-2">${new Date(r.date).toLocaleDateString()}</td>
                                            <td class="px-3 py-2">${r.userName}</td>
                                            <td class="px-3 py-2">${r.altoName}</td>
                                            <td class="px-3 py-2 font-medium">${r.h}h ${r.m}m</td>
                                        </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.view === 'coms') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-100">
                        <nav class="bg-blue-900 text-white p-4">
                            <div class="container mx-auto flex justify-between">
                                <h1 class="text-xl font-bold">Comunicados (${state.coms.length}/10)</h1>
                                <button onclick="state.view='admin';render()" class="bg-blue-700 px-4 py-2 rounded">Volver</button>
                            </div>
                        </nav>
                        <div class="container mx-auto p-4">
                            <div class="bg-white rounded-lg shadow p-6 mb-6">
                                <h2 class="text-xl font-bold mb-4">Crear</h2>
                                <form onsubmit="addCom(event)" class="space-y-4">
                                    <input type="text" id="ct" placeholder="T√≠tulo" required class="w-full px-4 py-2 border rounded">
                                    <textarea id="cc" placeholder="Contenido" class="w-full px-4 py-2 border rounded h-32" required></textarea>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" id="cu" class="w-4 h-4">
                                        <span>Urgente</span>
                                    </label>
                                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Publicar</button>
                                </form>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <h2 class="text-xl font-bold mb-4">Activos</h2>
                                ${state.coms.length === 0 ? '<p class="text-gray-500 text-center py-4">Sin comunicados</p>' :
                                state.coms.map(c => `
                                <div class="border rounded p-4 mb-4 ${c.urg ? 'bg-red-50 border-red-300' : 'bg-gray-50'}">
                                    <div class="flex justify-between">
                                        <div class="flex-1">
                                            <h3 class="font-bold">${c.tit} ${c.urg ? '<span class="bg-red-500 text-white text-xs px-2 py-1 rounded ml-2">URGENTE</span>' : ''}</h3>
                                            <p class="text-sm text-gray-600">${c.by} ‚Ä¢ ${new Date(c.date).toLocaleDateString()}</p>
                                        </div>
                                        <button onclick="delCom(${c.id})" class="text-red-600">üóëÔ∏è</button>
                                    </div>
                                    <p class="mt-2">${c.con}</p>
                                </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.view === 'bajo') {
                const t = state.timers[state.user.id];
                const myRecs = state.records.filter(r => r.userId === state.user.id);
                const myActas = state.actas.filter(a => a.uid === state.user.id);
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-100">
                        <nav class="bg-green-700 text-white p-4">
                            <div class="container mx-auto flex justify-between">
                                <h1 class="text-xl font-bold">${state.user.name}</h1>
                                <button onclick="logout()" class="bg-green-600 px-4 py-2 rounded">Salir</button>
                            </div>
                        </nav>
                        <div class="container mx-auto p-4">
                            ${state.coms.length > 0 ? `
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4 rounded">
                                <h3 class="font-bold mb-2">üì¢ Comunicados</h3>
                                ${state.coms.map(c => `<div class="mb-2 p-2 rounded ${c.urg?'bg-red-100':'bg-white'}"><p class="font-medium">${c.tit}</p><p class="text-sm">${c.con}</p></div>`).join('')}
                            </div>
                            ` : ''}
                            ${myActas.length > 0 ? `
                            <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-4 rounded">
                                <h3 class="font-bold">‚ö†Ô∏è Tienes ${myActas.length} acta(s)</h3>
                            </div>
                            ` : ''}
                            <div class="bg-white rounded-lg shadow p-6 mb-6">
                                <h2 class="text-2xl font-bold mb-4">‚è±Ô∏è Control de Tiempo</h2>
                                ${!t ? `
                                <div class="space-y-4">
                                    <p>Ingresa c√≥digo de autorizaci√≥n:</p>
                                    <div class="flex gap-2">
                                        <input type="text" id="code" placeholder="C√ìDIGO" class="flex-1 px-4 py-3 border rounded uppercase">
                                        <button onclick="startTimer()" class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700">‚ñ∂Ô∏è Iniciar</button>
                                    </div>
                                </div>
                                ` : `
                                <div class="space-y-4">
                                    <div class="bg-green-50 p-6 rounded text-center">
                                        <p class="text-sm text-gray-600 mb-2">Tiempo Actual</p>
                                        <p class="text-5xl font-bold text-green-700 mb-2">${fmt(t.elapsed)}</p>
                                        <p class="text-sm">Supervisor: ${t.altoName}</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="toggle()" class="flex-1 ${t.running?'bg-yellow-500':'bg-green-600'} text-white px-6 py-3 rounded">${t.running?'‚è∏Ô∏è Pausar':'‚ñ∂Ô∏è Reanudar'}</button>
                                        <button onclick="stop()" class="bg-red-600 text-white px-6 py-3 rounded">‚èπÔ∏è Detener</button>
                                    </div>
                                </div>
                                `}
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <h2 class="text-xl font-bold mb-4">Mi Historial</h2>
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left">Fecha</th>
                                            <th class="px-4 py-2 text-left">Tiempo</th>
                                            <th class="px-4 py-2 text-left">Supervisor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${myRecs.length === 0 ? '<tr><td colspan="3" class="px-4 py-8 text-center text-gray-500">Sin registros</td></tr>' :
                                        myRecs.map(r => `
                                        <tr class="border-t">
                                            <td class="px-4 py-3">${new Date(r.date).toLocaleDateString()}</td>
                                            <td class="px-4 py-3 font-medium">${r.h}h ${r.m}m</td>
                                            <td class="px-4 py-3">${r.altoName}</td>
                                        </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.view === 'alto') {
                const activos = Object.entries(state.timers).map(([uid, t]) => {
                    const u = state.users.find(x => x.id === parseInt(uid));
                    return {...t, uid: parseInt(uid), uname: u?.name};
                });
                const myCodes = Object.entries(state.codes).filter(([c, d]) => d.altoId === state.user.id);
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-100">
                        <nav class="bg-blue-700 text-white p-4">
                            <div class="container mx-auto flex justify-between">
                                <h1 class="text-xl font-bold">Cargo Alto - ${state.user.name}</h1>
                                <button onclick="logout()" class="bg-blue-600 px-4 py-2 rounded">Salir</button>
                            </div>
                        </nav>
                        <div class="container mx-auto p-4">
                            ${state.coms.length > 0 ? `
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4 rounded">
                                <h3 class="font-bold mb-2">üì¢ Comunicados</h3>
                                ${state.coms.map(c => `<div class="mb-2 p-2 rounded ${c.urg?'bg-red-100':'bg-white'}"><p class="font-medium">${c.tit}</p><p class="text-sm">${c.con}</p></div>`).join('')}
                            </div>
                            ` : ''}
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="bg-white rounded-lg shadow p-6">
                                    <h2 class="text-xl font-bold mb-4">üîë C√≥digos</h2>
                                    <button onclick="genCode()" class="w-full bg-blue-600 text-white py-3 rounded hover:bg-blue-700 mb-4">‚ûï Generar</button>
                                    <h3 class="font-medium mb-2">Activos:</h3>
                                    ${myCodes.length === 0 ? '<p class="text-gray-500 text-sm">Sin c√≥digos</p>' :
                                    myCodes.map(([code, d]) => `
                                    <div class="bg-blue-50 p-3 rounded flex justify-between mb-2">
                                        <span class="font-mono font-bold text-lg">${code}</span>
                                        <span class="text-sm text-gray-600">Usos: ${d.used.length}</span>
                                    </div>
                                    `).join('')}
                                </div>
                                <div class="bg-white rounded-lg shadow p-6">
                                    <h2 class="text-xl font-bold mb-4">‚ûï Tiempo Manual</h2>
                                    <form onsubmit="addManual(event)" class="space-y-3">
                                        <select id="mu" class="w-full px-4 py-2 border rounded" required>
                                            <option value="">Trabajador</option>
                                            ${state.users.filter(u => u.role === 'bajo').map(u => `<option value="${u.id}">${u.name}</option>`).join('')}
                                        </select>
                                        <div class="grid grid-cols-2 gap-2">
                                            <input type="number" id="mh" placeholder="Horas" min="0" value="0" class="px-4 py-2 border rounded">
                                            <input type="number" id="mm" placeholder="Minutos" min="0" max="59" value="0" class="px-4 py-2 border rounded">
                                        </div>
                                        <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Agregar</button>
                                    </form>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg shadow p-6">
                                <h2 class="text-xl font-bold mb-4">üë• Trabajadores Activos</h2>
                                ${activos.length === 0 ? '<p class="text-gray-500 text-center py-8">Sin trabajadores activos</p>' :
                                `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    ${activos.map(a => `
                                    <div class="border rounded-lg p-4 bg-green-50">
                                        <h3 class="font-bold text-lg mb-2">${a.uname}</h3>
                                        <p class="text-3xl font-bold text-green-700 mb-2">${fmt(a.elapsed)}</p>
                                        <p class="text-sm text-gray-600 mb-3">${a.running ? 'üü¢ En curso' : '‚è∏Ô∏è Pausado'}</p>
                                        <button onclick="stopUser(${a.uid})" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700">Detener</button>
                                    </div>
                                    `).join('')}
                                </div>`}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function addManual(e) {
            e.preventDefault();
            const uid = parseInt(document.getElementById('mu').value);
            const h = parseInt(document.getElementById('mh').value) || 0;
            const m = parseInt(document.getElementById('mm').value) || 0;
            const u = state.users.find(x => x.id === uid);
            const secs = (h * 3600) + (m * 60);
            state.records.push({
                id: state.records.length+1,
                userId: uid,
                userName: u.name,
                altoId: state.user.id,
                altoName: state.user.name,
                secs: secs,
                h: h,
                m: m,
                date: new Date().toISOString(),
                manual: true
            });
            save();
            alert(`Agregado: ${h}h ${m}m a ${u.name}`);
            render();
        }

        setInterval(() => {
            Object.keys(state.timers).forEach(uid => {
                if (state.timers[uid].running) {
                    state.timers[uid].elapsed++;
                }
            });
            if (state.view === 'bajo' || state.view === 'alto') {
                render();
            }
        }, 1000);

        load();
        render();
    </script>
</body>
</html>
