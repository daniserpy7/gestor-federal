<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GestorFederal</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div id="app"></div>
<script>
let S={u:null,us:[{id:1,username:'admin',password:'admin123',role:'admin',name:'Administrador'}],tm:{},cd:{},acd:{},rc:[],ac:[],cm:[],v:'login',eu:null,cp:false,on:{},la:{}};
let ti=null,ai=null;

function sv(){localStorage.setItem('gfd',JSON.stringify({us:S.us,cd:S.cd,acd:S.acd,rc:S.rc,ac:S.ac,cm:S.cm}))}
function ld(){try{let d=JSON.parse(localStorage.getItem('gfd'));if(d){S.us=d.us||S.us;S.cd=d.cd||{};S.acd=d.acd||{};S.rc=d.rc||[];S.ac=d.ac||[];S.cm=d.cm||[]}}catch(e){}}
function fmt(s){let h=Math.floor(s/3600),m=Math.floor(s%3600/60),sec=s%60;return `${h}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`}

function ua(){if(S.u)S.la[S.u.id]=Date.now()}
function cos(){let n=Date.now();Object.keys(S.la).forEach(uid=>{S.on[uid]=(n-S.la[uid])<60000})}

function login(e){
e.preventDefault();
let u=document.getElementById('u').value,p=document.getElementById('p').value;
let user=S.us.find(x=>x.username===u&&x.password===p);
if(user){S.u=user;S.v=user.role==='admin'?'admin':user.role==='alto'?'alto':'bajo';S.la[user.id]=Date.now();S.on[user.id]=true;r();sti();sai()}
else alert('Credenciales incorrectas')
}

function logout(){if(S.u)S.on[S.u.id]=false;S.u=null;S.v='login';stpi();sapi();r()}

function sti(){
if(ti)return;
ti=setInterval(()=>{
let h=false;
Object.keys(S.tm).forEach(uid=>{if(S.tm[uid].r){S.tm[uid].e++;h=true}});
if(h){document.querySelectorAll('.tm').forEach(el=>{let uid=el.dataset.uid;if(S.tm[uid])el.textContent=fmt(S.tm[uid].e)})}
},1000)
}

function stpi(){if(ti){clearInterval(ti);ti=null}}
function sai(){if(ai)return;ai=setInterval(()=>{ua();cos()},10000)}
function sapi(){if(ai){clearInterval(ai);ai=null}}

function gc(){
let c=Math.random().toString(36).substring(2,8).toUpperCase();
S.cd[c]={ai:S.u.id,an:S.u.name};
alert('Código: '+c);r()
}

function gac(){
let c=Math.random().toString(36).substring(2,8).toUpperCase();
S.acd[c]={ai:S.u.id,an:S.u.name};
alert('Código Admin: '+c+'\n(Para crear actas)');r()
}

function st(){
let c=document.getElementById('cd').value.toUpperCase();
if(!S.cd[c]){alert('Código inválido');return}
S.tm[S.u.id]={e:0,r:true,ai:S.cd[c].ai,an:S.cd[c].an};
r()
}

function stp(){
let t=S.tm[S.u.id];
if(t){
let sec=t.e,m=Math.floor(sec/60),h=Math.floor(m/60);
S.rc.push({id:S.rc.length+1,uid:S.u.id,un:S.u.name,ai:t.ai,an:t.an,h:h,m:m%60,s:sec%60,d:new Date().toISOString()});
delete S.tm[S.u.id];sv();alert(`Registrado: ${h}h ${m%60}m ${sec%60}s`);r()
}
}

function stpu(uid){
let t=S.tm[uid];
if(t){
let sec=t.e,m=Math.floor(sec/60),h=Math.floor(m/60),u=S.us.find(x=>x.id===uid);
S.rc.push({id:S.rc.length+1,uid:uid,un:u.name,ai:t.ai,an:t.an,h:h,m:m%60,s:sec%60,d:new Date().toISOString(),sb:S.u.name});
delete S.tm[uid];sv();alert(`Detenido: ${u.name} ${h}h ${m%60}m ${sec%60}s`);r()
}
}

function au(e){
e.preventDefault();
let n=document.getElementById('un').value,u=document.getElementById('uu').value,p=document.getElementById('up').value,ro=document.getElementById('ur').value;
if(S.us.find(x=>x.username===u)){alert('Usuario existe');return}
S.us.push({id:S.us.length+1,username:u,password:p,role:ro,name:n});sv();alert('Usuario creado');r()
}

function eu(id){S.eu=S.us.find(u=>u.id===id);r()}

function sue(e){
e.preventDefault();
let u=S.us.find(u=>u.id===S.eu.id);
u.name=document.getElementById('eun').value;
u.username=document.getElementById('euun').value;
u.password=document.getElementById('eup').value;
u.role=document.getElementById('eur').value;
S.eu=null;sv();alert('Usuario actualizado');r()
}

function cue(){S.eu=null;r()}

function cp(e){
e.preventDefault();
let curr=document.getElementById('cpc').value,newp=document.getElementById('cpn').value,conf=document.getElementById('cpnc').value;
if(S.u.password!==curr){alert('Contraseña actual incorrecta');return}
if(newp!==conf){alert('Las contraseñas no coinciden');return}
if(newp.length<3){alert('Mínimo 3 caracteres');return}
let u=S.us.find(u=>u.id===S.u.id);
u.password=newp;S.u.password=newp;S.cp=false;sv();alert('✅ Contraseña cambiada');r()
}

function aa(e){
e.preventDefault();
let uid=parseInt(document.getElementById('auid').value),mot=document.getElementById('amot').value;
let authc=document.getElementById('aac')?.value?.toUpperCase();
if(S.u.role==='alto'){
if(!authc){alert('Necesitas código de Admin');return}
if(!S.acd[authc]){alert('Código de Admin inválido');return}
delete S.acd[authc]
}
let u=S.us.find(x=>x.id===uid);
S.ac.push({id:S.ac.length+1,uid:uid,un:u.name,mot:mot,by:S.u.name,byr:S.u.role,d:new Date().toISOString()});
sv();alert('Acta creada');r()
}

function acm(e){
e.preventDefault();
if(S.cm.length>=10){alert('Máximo 10');return}
let t=document.getElementById('cmt').value,c=document.getElementById('cmc').value,urg=document.getElementById('cmu').checked;
S.cm.push({id:S.cm.length+1,t:t,c:c,urg:urg,by:S.u.name,d:new Date().toISOString()});
sv();alert('Comunicado creado');r()
}

function dcm(id){if(confirm('¿Eliminar?')){S.cm=S.cm.filter(x=>x.id!==id);sv();r()}}

function gsb(uid){return S.on[uid]?'<span class="text-xs bg-green-500 text-white px-2 py-1 rounded-full">🟢 Online</span>':'<span class="text-xs bg-gray-400 text-white px-2 py-1 rounded-full">⚫ Offline</span>'}

function gtr(){
let tots={};
S.rc.forEach(r=>{
if(!tots[r.ai])tots[r.ai]={name:r.an,secs:0,recs:[]};
tots[r.ai].secs+=(r.h*3600+r.m*60+r.s);
tots[r.ai].recs.push(r);
});
return Object.entries(tots).map(([id,d])=>{
let h=Math.floor(d.secs/3600),m=Math.floor((d.secs%3600)/60),s=d.secs%60;
return{id,name:d.name,secs:d.secs,h,m,s,recs:d.recs}
}).sort((a,b)=>b.secs-a.secs)
}

function r(){
ua();
let a=document.getElementById('app');
if(S.v==='login'){
a.innerHTML=`<div class="min-h-screen bg-gradient-to-br from-blue-900 to-blue-700 flex items-center justify-center p-4">
<div class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
<h1 class="text-4xl font-bold text-blue-900 text-center mb-2">GestorFederal</h1>
<p class="text-gray-600 text-center mb-6">Sistema de Control de Tiempos</p>
<form onsubmit="login(event)" class="space-y-4">
<input type="text" id="u" placeholder="Usuario" required class="w-full px-4 py-3 border rounded-lg">
<input type="password" id="p" placeholder="Contraseña" required class="w-full px-4 py-3 border rounded-lg">
<button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Ingresar</button>
</form>
<div class="mt-4 p-3 bg-gray-50 rounded text-sm"><p>Prueba: <b>admin / admin123</b></p></div>
</div></div>`
}else if(S.v==='admin'){
a.innerHTML=`<div class="min-h-screen bg-gray-100">
<nav class="bg-blue-900 text-white p-4">
<div class="container mx-auto flex justify-between items-center">
<h1 class="text-xl font-bold">GestorFederal - Admin</h1>
<div class="flex gap-2">
<button onclick="S.cp=true;r()" class="bg-blue-700 px-4 py-2 rounded hover:bg-blue-600">🔑</button>
<button onclick="logout()" class="bg-blue-700 px-4 py-2 rounded hover:bg-blue-600">Salir</button>
</div></div></nav>
${S.cp?`<div class="container mx-auto p-4">
<div class="bg-white rounded-lg shadow p-6 max-w-md mx-auto">
<h2 class="text-xl font-bold mb-4">🔑 Cambiar Contraseña</h2>
<form onsubmit="cp(event)" class="space-y-4">
<input type="password" id="cpc" placeholder="Contraseña actual" required class="w-full px-4 py-2 border rounded">
<input type="password" id="cpn" placeholder="Nueva contraseña" required class="w-full px-4 py-2 border rounded">
<input type="password" id="cpnc" placeholder="Confirmar nueva" required class="w-full px-4 py-2 border rounded">
<div class="flex gap-2">
<button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700">Guardar</button>
<button type="button" onclick="S.cp=false;r()" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">Cancelar</button>
</div></form></div></div>`:`<div class="container mx-auto p-4">
<div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
<button onclick="S.v='users';r()" class="bg-white p-6 rounded-lg shadow hover:shadow-lg"><h3 class="font-bold">👥 Usuarios</h3></button>
<button onclick="S.v='actas';r()" class="bg-white p-6 rounded-lg shadow hover:shadow-lg"><h3 class="font-bold">📄 Actas</h3></button>
<button onclick="S.v='bit';r()" class="bg-white p-6 rounded-lg shadow hover:shadow-lg"><h3 class="font-bold">🏆 Bitácora</h3></button>
<button onclick="S.v='coms';r()" class="bg-white p-6 rounded-lg shadow hover:shadow-lg"><h3 class="font-bold">📢 Comunicados</h3></button>
<button onclick="S.v='admin-time';r()" class="bg-white p-6 rounded-lg shadow hover:shadow-lg"><h3 class="font-bold">⏱️ Tomar Time</h3></button>
</div>
<div class="bg-white rounded-lg shadow p-6 mb-6">
<h2 class="text-xl font-bold mb-4">Generar Código para Actas</h2>
<button onclick="gac()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700">🔐 Generar Código Admin</button>
<p class="text-sm text-gray-600 mt-2">Los Cargos Altos necesitan este código para crear actas</p>
</div>
<div class="bg-white rounded-lg shadow p-6">
<h2 class="text-2xl font-bold mb-4">Estadísticas</h2>
<div class="grid grid-cols-3 gap-4">
<div class="bg-blue-50 p-4 rounded"><p class="text-sm">Usuarios</p><p class="text-3xl font-bold text-blue-600">${S.us.length}</p></div>
<div class="bg-green-50 p-4 rounded"><p class="text-sm">Registros</p><p class="text-3xl font-bold text-green-600">${S.rc.length}</p></div>
<div class="bg-purple-50 p-4 rounded"><p class="text-sm">Actas</p><p class="text-3xl font-bold text-purple-600">${S.ac.length}</p></div>
</div></div></div>`}</div>`
}else if(S.v==='admin-time'){
let act=Object.entries(S.tm).filter(([uid])=>{let u=S.us.find(x=>x.id===parseInt(uid));return u&&u.role==='alto'}).map(([uid,t])=>{let u=S.us.find(x=>x.id===parseInt(uid));return{...t,uid:parseInt(uid),un:u?.name}});
a.innerHTML=`<div class="min-h-screen bg-gray-100">
<nav class="bg-blue-900 text-white p-4">
<div class="container mx-auto flex justify-between">
<h1 class="text-xl font-bold">Tomar Tiempo a Cargos Altos</h1>
<button onclick="S.v='admin';r()" class="bg-blue-700 px-4 py-2 rounded">Volver</button>
</div></nav>
<div class="container mx-auto p-4">
<div class="bg-white rounded-lg shadow p-6 mb-6">
<h2 class="text-xl font-bold mb-4">🔑 Códigos para Cargos Altos</h2>
<button onclick="gc()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 mb-4">➕ Generar Código</button>
<div class="space-y-2">
${Object.entries(S.cd).filter(([c,d])=>d.ai===S.u.id).map(([c])=>`<div class="bg-blue-50 p-3 rounded-lg border">
<span class="font-mono font-bold text-xl">${c}</span>
</div>`).join('')||'<p class="text-gray-500 text-sm">Sin códigos</p>'}
</div></div>
<div class="bg-white rounded-lg shadow p-6">
<h2 class="text-xl font-bold mb-4">👥 Cargos Altos Activos</h2>
${act.length===0?'<p class="text-gray-500 text-center py-8">No hay cargos altos trabajando</p>':`<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
${act.map(a=>`<div class="border-2 rounded-lg p-4 bg-green-50">
<h3 class="font-bold text-lg mb-2">${a.un}</h3>
<p class="text-4xl font-bold text-green-700 mb-2 tm" data-uid="${a.uid}">${fmt(a.e)}</p>
<p class="text-sm text-gray-600 mb-3">${a.r?'🟢 Corriendo':'⏸️ Pausado'}</p>
<button onclick="stpu(${a.uid})" class="w-full bg-red-600 text-white py-2 rounded hover:bg-red-700">⏹️ Detener</button>
</div>`).join('')}
</div>`}
</div></div></div>`
}else if(S.v==='users'){
a.innerHTML=`<div class="min-h-screen bg-gray-100">
<nav class="bg-blue-900 text-white p-4">
<div class="container mx-auto flex justify-between">
<h1 class="text-xl font-bold">Gestión de Usuarios</h1>
<button onclick="S.v='admin';r()" class="bg-blue-700 px-4 py-2 rounded">Volver</button>
</div></nav>
<div class="container mx-auto p-4">
${S.eu?`<div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 mb-6 rounded-lg">
<h2 class="text-xl font-bold mb-4">✏️ Editar Usuario</h2>
<form onsubmit="sue(event)" class="grid grid-cols-2 gap-4">
<input type="text" id="eun" value="${S.eu.name}" placeholder="Nombre" required class="px-4 py-2 border rounded">
<input type="text" id="euun" value="${S.eu.username}" placeholder="Usuario" required class="px-4 py-2 border rounded">
<input type="password" id="eup" value="${S.eu.password}" placeholder="Contraseña" required class="px-4 py-2 border rounded">
<select id="eur" class="px-4 py-2 border rounded">
<option value="bajo" ${S.eu.role==='bajo'?'selected':''}>Cargo Bajo</option>
<option value="alto" ${S.eu.role==='alto'?'selected':''}>Cargo Alto</option>
<option value="admin" ${S.eu.role==='admin'?'selected':''}>Admin</option>
</select>
<div class="col-span-2 flex gap-2">
<button type="submit" class="flex-1 bg-green-600 text-white py-2 rounded hover:bg-green-700">💾 Guardar</button>
<button type="button" onclick="cue()" class="flex-1 bg-gray-500 text-white py-2 rounded hover:bg-gray-600">❌ Cancelar</button>
</div></form></div>`:`<div class="bg-white rounded-lg shadow p-6 mb-6">
<h2 class="text-xl font-bold mb-4">Crear Usuario</h2>
<form onsubmit="au(event)" class="grid grid-cols-2 gap-4">
<input type="text" id="un" placeholder="Nombre" required class="px-4 py-2 border rounded">
<input type="text" id="uu" placeholder="Usuario" required class="px-4 py-2 border rounded">
<input type="password" id="up" placeholder="Contraseña" required class="px-4 py-2 border rounded">
<select id="ur" class="px-4 py-2 border rounded">
<option value="bajo">Cargo Bajo</option>
<option value="alto">Cargo Alto</option>
<option value="admin">Admin</option>
</select>
<button type="submit" class="col-span-2 bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Crear Usuario</button>
</form></div>`}
<div class="bg-white rounded-lg shadow p-6">
<h2 class="text-xl font-bold mb-4">Lista de Usuarios</h2>
<div class="overflow-x-auto">
<table class="w-full">
<thead class="bg-gray-50"><tr>
<th class="px-4 py-2 text-left">Estado</th>
<th class="px-4 py-2 text-left">Nombre</th>
<th class="px-4 py-2 text-left">Usuario</th>
<th class="px-4 py-2 text-left">Rol</th>
<th class="px-4 py-2 text-left">Password</th>
<th class="px-4 py-2 text-left">Acciones</th>
</tr></thead>
<tbody>${S.us.map(u=>`<tr class="border-t">
<td class="px-4 py-2">${gsb(u.id)}</td>
<td class="px-4 py-2">${u.name}</td>
<td class="px-4 py-2">${u.username}</td>
<td class="px-4 py-2"><span class="px-2 py-1 text-xs rounded ${u.role==='admin'?'bg-red-100 text-red-800':u.role==='alto'?'bg-blue-100 text-blue-800':'bg-green-100 text-green-800'}">${u.role==='admin'?'Admin':u.role==='alto'?'Cargo Alto':'Cargo Bajo'}</span></td>
<td class="px-4 py-2">${u.password}</td>
<td class="px-4 py-2"><button onclick="eu(${u.id})" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">✏️ Editar</button></td>
</tr>`).join('')}</tbody>
</table></div></div></div></div>`
}else if(S.v==='actas'){
let ma=S.ac.filter(ac=>S.u.role==='admin'||ac.uid===S.u.id||ac.by===S.u.name);
a.innerHTML=`<div class="min-h-screen bg-gray-100">
<nav class="bg-blue-900 text-white p-4">
<div class="container mx-auto flex justify-between">
<h1 class="text-xl font-bold">Actas Administrativas</h1>
<button onclick="S.v='admin';r()" class="bg-blue-700 px-4 py-2 rounded">Volver</button>
</div></nav>
<div class="container mx-auto p-4">
<div class="bg-white rounded-lg shadow p-6 mb-6">
<h2 class="text-xl font-bold mb-4">Crear Acta</h2>
<form onsubmit="aa(event)" class="space-y-4">
<select id="auid" class="w-full px-4 py-2 border rounded" required>
<option value="">Seleccionar trabajador</option>
${S.us.filter(u=>u.role!=='admin').map(u=>`<option value="${u.id}">${u.name}</option>`).join('')}
</select>
<textarea id="amot" placeholder="Motivo" class="w-full px-4 py-2 border rounded h-32" required></textarea>
<button type="submit" class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700">Crear</button>
</form></div>
<div class="bg-white rounded-lg shadow p-6">
<h2 class="text-xl font-bold mb-4">Actas Registradas</h2>
${ma.length===0?'<p class="text-gray-500 text-center py-4">Sin actas</p>':ma.map(ac=>`<div class="border rounded p-4 mb-4 bg-red-50">
<h3 class="font-bold text-lg">Trabajador: ${ac.un}</h3>
<p class="text-sm text-gray-600">Por: ${ac.by} (${ac.byr==='admin'?'Admin':'Cargo Alto'}) • ${new Date(ac.d).toLocaleString()}</p>
<p class="mt-2">${ac.mot}</p>
</div>`).join('')}
</div></div></div>`
}else if(S.v==='bit'){
let rk=gtr();
a.innerHTML=`<div class="min-h-screen bg-gray-100">
<nav class="bg-blue-900 text-white p-4">
<div class="container mx-auto flex justify-between">
<h1 class="text-xl font-bold">Bitácora</h1>
<button onclick="S.v='admin';r()" class="bg-blue-700 px-4 py-2 rounded">Volver</button>
</div></nav>
<div class="container mx-auto p-4">
<div class="bg-white rounded-lg shadow p-6 mb-6">
<h2 class="text-xl font-bold mb-4">🏆 Ranking Cargos Altos</h2>
<p class="text-sm text-gray-600 mb-4">Total de tiempo supervisado (ordenado de mayor a menor)</p>
<div class="overflow-x-auto">
<table class="w-full">
<thead class="bg-gray-50"><tr>
<th class="px-4 py-2 text-left">#</th>
<th class="px-4 py-2 text-left">Cargo Alto</th>
<th class="px-4 py-2 text-left">Total Supervisado</th>
<th class="px-4 py-2 text-left">Registros</th>
</tr></thead>
<tbody>${rk.length===0?'<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Sin datos</td></tr>':rk.map((r,i)=>`<tr class="border-t ${i<3?'bg-yellow-50':''}">
<td class="px-4 py-3 font-bold">${i===0?'🥇':i===1?'🥈':i===2?'🥉':i+1}</td>
<td class="px-4 py-3 font-medium">${r.name}</td>
<td class="px-4 py-3"><span class="bg-green-100 text-green-800 px-3 py-1 rounded-full font-bold">${r.h}h ${r.m}m ${r.s}s</span></td>
<td class="px-4 py-3">${r.recs.length} registros</td>
</tr>`).join('')}</tbody>
</table></div></div>
<div class="bg-white rounded-lg shadow p-6">
<h2 class="text-xl font-bold mb-4">Todos los Registros</h2>
<div class="overflow-x-auto">
<table class="w-full text-sm">
<thead class="bg-gray-50"><tr>
<th class="px-3 py-2 text-left">Fecha</th>
<th class="px-3 py-2 text-left">Trabajador</th>
<th class="px-3 py-2 text-left">Cargo Alto</th>
<th class="px-3 py-2 text-left">Tiempo</th>
<th class="px-3 py-2 text-left">Detenido por</th>
</tr></thead>
<tbody>${S.rc.length===0?'<tr><td colspan="5" class="px-3 py-8 text-center text-gray-500">Sin registros</td></tr>':S.rc.map(r=>`<tr class="border-t">
<td class="px-3 py-2">${new Date(r.d).toLocaleString()}</td>
<td class="px-3 py-2">${r.un}</td>
<td class="px-3 py-2">${r
